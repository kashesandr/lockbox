{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 52e4eb3fc59eac501ca0","webpack:///./src/main.js","webpack:///./src/App.js","webpack:///./src/services/Auth.js","webpack:///./src/logger.js","webpack:///./src/settings.js","webpack:///./src/Devices.js","webpack:///./src/Utils.js","webpack:///./src/services/SignalDetection.js"],"names":["App","run","logger","log","DEBUG_DEFAULT_CODE","auth","Auth","bluetooth","Bluetooth","serialPort","settings","pin","bluetoothSerial","relay","Relay","relayPin","knockDevice","KnockDevice","knockPin","signalDetectionService","SignalDetectionService","triggerRelay","timeout","set","setTimeout","isReadyToSetUpNewCode","onDataReceived","data","onKnock","e","timestamp","time","lastTime","putTimestamp","setCode","onSignalDetect","code","authenticated","verifyCode","fluctuation","Array","length","slice","signalEnd","codeEnd","coeff","result","forEach","codeItem","index","stamp","withinRange","Logger","isEnabled","message","arg","txt","console","print","bool","P2","P3","Serial3","DEFAULT_BAUD_RATE","DEFAULT_DEBOUNCE_TIMEOUT","options","serial","rate","baudRate","debouceTimeout","debounceTimeout","setup","receivedDataArray","onDataReceivedCallback","onDataReceivedDebounced","_onDataReceived","on","onDataReceiving","bind","push","join","callback","write","KNOCK_DEVICE_SET_WATCH_OPTS_DEFAULT","repeat","debounce","edge","KNOCK_DEVICE_DEBOUNCE","setWatchOpts","onKnockCallback","shakeTimeout","watcher","onKnockEvent","undefined","setWatch","func","wait","immediate","timeoutId","context","args","arguments","later","apply","callNow","clearTimeout","CODE_DETECT_TIMEOUT_DEFAULT","codeDetectionTimeout","signalTimestamps","signalDetectionInProgress","updateCodeDetectionDebounced","detectCodeDebounced","onCodeDetected","onSignalDetectCallback"],"mappings":"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","file":"main.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"main\"] = factory();\n\telse\n\t\troot[\"main\"] = factory();\n})(this, function() {\nreturn \n\n\n/** WEBPACK FOOTER **\n ** webpack/universalModuleDefinition\n **/"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n/** WEBPACK FOOTER **\n ** webpack/bootstrap 52e4eb3fc59eac501ca0\n **/","import { App } from \"./App\";\n\nApp.run();\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/main.js\n **/","import { Auth } from \"./services/Auth\";\nimport { logger } from \"./logger\";\nimport { settings } from \"./settings\";\nimport { Bluetooth, Relay, KnockDevice } from \"./Devices\";\nimport { SignalDetectionService } from \"./services/SignalDetection\";\n\nlogger.log('main.js');\n\nconst DEBUG_DEFAULT_CODE = [\n  0.11071835714,0.08259338095,0.10016359523,0.30911060714,0.09569125595,0.51507855357,0.07772857142\n];\n\nlet App = {\n\n  run: () => {\n\n    let auth = new Auth();\n    let bluetooth = new Bluetooth({serialPort: settings.pin.bluetoothSerial});\n    let relay = new Relay({pin: settings.pin.relayPin});\n    let knockDevice = new KnockDevice({pin: settings.pin.knockPin});\n\n    let signalDetectionService = new SignalDetectionService();\n\n    let triggerRelay = (relay, timeout = 400) => {\n      relay.set(0);\n      setTimeout((()=>{\n        relay.set(1)\n      }), timeout);\n    };\n\n    let isReadyToSetUpNewCode = false;\n    bluetooth.onDataReceived( (data) => {\n      if (data === \"set\") {\n        isReadyToSetUpNewCode = true;\n      }\n      if (data === \"open\") {\n        triggerRelay(relay);\n      }\n    });\n\n    knockDevice.onKnock((e) => {\n      // there is a mistake (e.time - e.lastTime) -> fix it\n      let timestamp = e.time - e.lastTime;\n      signalDetectionService.putTimestamp(timestamp);\n    });\n\n    // TODO: set the code manually\n    auth.setCode(DEBUG_DEFAULT_CODE);\n\n    signalDetectionService.onSignalDetect( (code) => {\n\n      logger.log('code-detected', code);\n\n      if (isReadyToSetUpNewCode) {\n        // TODO: store new code in FlashEEPROM\n        // TODO: details https://www.espruino.com/FlashEEPROM\n        auth.setCode(code);\n        logger.log('new code has been set');\n        isReadyToSetUpNewCode = false;\n      } else {\n        let authenticated = auth.verifyCode(code);\n        logger.log('authenticated', authenticated);\n\n        if (authenticated) {\n          triggerRelay(relay);\n        }\n\n      }\n    });\n\n  }\n\n};\n\nexport { App };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/App.js\n **/","import {logger} from \"./../logger\";\n\nlogger.log('Auth.js');\n\nconst Auth = class {\n\n  constructor() {\n    this.code = []; // storing key code, an array of timestamps\n    this.fluctuation = 150; // TODO: must be in percents\n  }\n\n  setCode(code){\n    if (!code) return;\n    if (!(code instanceof Array)) return;\n    this.code = code;\n  }\n  getCode(){\n    return this.code;\n  }\n\n  verifyCode(code){\n    if (!code) return false;\n    if (!(code instanceof Array)) return false;\n    if (code.length !== this.code.length) return false;\n\n    const [signalEnd] = code.slice(-1);\n    const [codeEnd] = this.code.slice(-1);\n\n    let coeff = signalEnd/codeEnd;\n    let result = true;\n    let fluctuation = this.fluctuation;\n    this.code.forEach( (codeItem, index) => {\n      let stamp = code[index]/coeff;\n      let withinRange = ((stamp + fluctuation) >= codeItem && (stamp - fluctuation) <= codeItem);\n      if (!withinRange)\n        result = false;\n    } );\n\n    return result;\n  }\n\n};\n\nexport { Auth };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/services/Auth.js\n **/","import { settings } from './settings';\n\n/**\n * Simplest silly logger for debugging\n *\n * Actually there is a bug with it.\n * For some reason the app is unstable when\n * something is pushed into console.log,\n * as I found - Espruino waits for recipients for logged data\n * and breaks logic if there are no ones\n *\n * @type {Logger}\n */\nconst Logger = class {\n\n  constructor (bluetoothSerial) {\n    this.isEnabled = false;\n    this.bluetoothSerial = bluetoothSerial;\n  }\n\n  log (message, arg) {\n    if (!this.isEnabled) return false;\n    let txt = `${message}: ${arg}`;\n    if (console && console.log)\n      console.log(txt);\n    if (this.bluetoothSerial)\n      this.bluetoothSerial.print(txt);\n  }\n\n  enabled (bool) {\n    this.isEnabled = bool;\n  }\n\n};\n\nlet logger = new Logger(settings.pin.bluetoothSerial);\n\n// TODO: enable when debugging\n//logger.enabled(true);\n\nexport { logger };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/logger.js\n **/","\n// mocking for testing\n// TODO: do not include in prod\n// let BTN1 = BTN1 || null;\n// let P3 = P3 || null;\n// let Serial3 = Serial3 || null;\n\nconst settings = {\n  pin: {\n    knockPin: P2,\n    relayPin: P3,\n    bluetoothSerial: Serial3\n  }\n};\n\nexport { settings };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/settings.js\n **/","import { logger } from \"./logger\";\nimport {debounce} from \"./Utils\";\n\nlogger.log('Devices.js');\n\n/**\n * Bluetooth module\n * example:\n *\n  ```\n    import { Bluetooth } from \"./Devices\";\n    let options = {\n      serialPort: <Object> // e.g. Serial3\n      baudRate: <Number> // e.g. 9600 <- this is default\n      debounceTimeout: <Number> // e.g. 100 <- this is default\n    };\n    let bluetooth = new Bluetooth(options);\n  ```\n *\n */\nconst DEFAULT_BAUD_RATE = 9600;\nconst DEFAULT_DEBOUNCE_TIMEOUT = 100;\n\nconst Bluetooth = class {\n\n  constructor(options){\n    let serial = options.serialPort;\n    let rate = options.baudRate || DEFAULT_BAUD_RATE;\n    let debouceTimeout = options.debounceTimeout || DEFAULT_DEBOUNCE_TIMEOUT;\n    serial.setup(rate);\n\n    this.receivedDataArray = [];\n    this.onDataReceivedCallback = (() => {});\n\n    this.onDataReceivedDebounced =\n      debounce( () => { this._onDataReceived() }, debouceTimeout );\n\n    serial.on('data', this.onDataReceiving.bind(this));\n\n  }\n\n  onDataReceiving(data){\n    this.receivedDataArray.push(data);\n    this.onDataReceivedDebounced();\n  }\n\n  _onDataReceived(){\n    let data = this.receivedDataArray.join(\"\");\n    logger.log(\"Bluetooth._onDataReceoved\", data);\n    this.onDataReceivedCallback(data);\n    this.receivedDataArray = [];\n  }\n\n  onDataReceived(callback){\n    this.onDataReceivedCallback = callback || (()=>{});\n  }\n\n};\n\n/**\n * Relay utility module\n * example:\n *\n\n ```\n  import { Relay } from \"./Devices\";\n  let options = {\n    pin: <Object>, // e,g, P1\n  };\n  let relay = new Relay(options);\n\n  relay.set(1);\n  relay.set(true);\n  relay.set(0);\n  relay.set(false);\n\n ```\n *\n */\n\nconst Relay = class {\n\n  constructor(options){\n    this.pin = options.pin;\n  }\n\n  set(bool){\n    this.pin.write(bool ? 1 : 0);\n  }\n\n};\n\n/**\n * KnockDevice module\n * example:\n *\n ```\n import { KnockDevice } from \"./Devices\";\n let options = {\n      pin: <Object>, // e,g, P1\n      setWatchOpts: <Object> // opts passed to setWatch fn\n    };\n let knockDevice = new KnockDevice(options);\n knockDevice.onKnock((e)=>{\n  // callback when knock\n });\n ```\n *\n */\n\nconst KNOCK_DEVICE_SET_WATCH_OPTS_DEFAULT = {\n  repeat: true,\n  debounce: 20,\n  edge: 'rising'\n};\nconst KNOCK_DEVICE_DEBOUNCE = 100;\n\nconst KnockDevice = class {\n\n  constructor(options) {\n    logger.log(\"setup KnockDevice\");\n    let pin = options.pin;\n    let setWatchOpts = options.setWatchOpts || KNOCK_DEVICE_SET_WATCH_OPTS_DEFAULT;\n    this.onKnockCallback = (()=>{});\n\n    // here we use KNOCK_DEVICE_DEBOUNCE\n    // in order to catch only first knocking\n    let shakeTimeout;\n    let watcher = (e) => {\n      if (shakeTimeout) return;\n      this.onKnockEvent(e);\n      shakeTimeout = setTimeout(\n        () => { shakeTimeout = undefined; }\n        , KNOCK_DEVICE_DEBOUNCE\n      );\n    };\n\n    setWatch(watcher, pin, setWatchOpts);\n\n  }\n\n  onKnockEvent(e) {\n    logger.log(\"KnockDevice onKnockEvent\");\n    this.onKnockCallback(e);\n  }\n\n  onKnock(callback) {\n    this.onKnockCallback = callback || (() => {});\n  }\n\n};\n\nexport { Bluetooth, Relay, KnockDevice };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/Devices.js\n **/","const debounce = (func, wait, immediate) => {\n  let timeoutId = null;\n  return function() {\n    let context = this, args = arguments;\n    let later = function() {\n      timeoutId = null;\n      if (!immediate) func.apply(context, args);\n    };\n    let callNow = immediate && !timeoutId;\n    if (timeoutId) clearTimeout(timeoutId);\n    timeoutId = setTimeout(later, wait);\n    if (callNow) func.apply(context, args);\n  };\n};\n\nexport { debounce };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/Utils.js\n **/","import { logger } from \"../logger\";\nimport { debounce } from \"../Utils\";\n\nlogger.log('signal-detection.js', 'loaded');\n\n/**\n *\n * Service that helps to putTimestamp timestamped code\n *\n */\n\nconst CODE_DETECT_TIMEOUT_DEFAULT = 2000;\n\nconst SignalDetectionService = class {\n\n  constructor() {\n\n    this.codeDetectionTimeout = CODE_DETECT_TIMEOUT_DEFAULT;\n    this.signalTimestamps = [];\n    this.signalDetectionInProgress = false;\n\n    this.updateCodeDetectionDebounced();\n\n  }\n\n  updateCodeDetectionDebounced (\n    codeDetectionTimeout =\n      this.codeDetectionTimeout || CODE_DETECT_TIMEOUT_DEFAULT\n  ) {\n    logger.log('SignalDetectionService.updateCodeDetectionDebounced()', codeDetectionTimeout);\n    this.detectCodeDebounced = debounce(\n      this.onCodeDetected.bind(this),\n      codeDetectionTimeout\n    );\n  }\n\n  /**\n   * @param timestamp\n   */\n  putTimestamp (timestamp) {\n    logger.log('SignalDetectionService.putTimestamp()', timestamp);\n    if (this.signalDetectionInProgress) {\n      this.signalTimestamps.push(timestamp);\n    }\n    this.signalDetectionInProgress = true;\n    this.detectCodeDebounced();\n  }\n\n  onCodeDetected () {\n    logger.log(\"SignalDetectionService.onCodeDetected\", 'called');\n\n    let callback = this.onSignalDetectCallback || (() => {});\n    callback(this.signalTimestamps);\n\n    this.signalTimestamps = [];\n    this.signalDetectionInProgress = false;\n  }\n\n  onSignalDetect(callback){\n    this.onSignalDetectCallback = callback; // todo check context\n  }\n\n  setDetectionTimeout (timeout) {\n    this.codeDetectionTimeout = timeout;\n    this.updateCodeDetectionDebounced();\n  }\n\n  getTimestamps(){\n    return this.signalTimestamps;\n  }\n\n};\n\nexport { SignalDetectionService };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/services/SignalDetection.js\n **/"],"sourceRoot":""}