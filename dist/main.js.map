{"version":3,"sources":["webpack:///webpack/universalModuleDefinition","webpack:///webpack/bootstrap 552385c86ff347ed4ead","webpack:///./src/main.js","webpack:///./src/App.js","webpack:///./src/services/Auth.js","webpack:///./src/logger.js","webpack:///./src/settings.js","webpack:///./src/Devices.js","webpack:///./src/Utils.js","webpack:///./src/services/SignalDetection.js"],"names":["App","run","logger","log","DEBUG_DEFAULT_CODE","isReadyToSetUpNewCode","auth","Auth","bluetooth","Bluetooth","serialPort","settings","pin","bluetoothSerial","relay","Relay","relayPin","knockDevice","KnockDevice","knockPin","signalDetectionService","SignalDetectionService","onDataReceived","onKnock","e","timestamp","time","lastTime","putTimestamp","setCode","onSignalDetect","code","authenticated","verifyCode","set","setTimeout","fluctuation","Array","length","slice","signalEnd","codeEnd","coeff","result","forEach","codeItem","index","stamp","withinRange","Logger","isEnabled","message","arg","txt","console","print","bool","P2","P3","Serial3","DEFAULT_BAUD_RATE","DEFAULT_DEBOUNCE_TIMEOUT","options","serial","rate","baudRate","debouceTimeout","debounceTimeout","setup","receivedDataArray","onDataReceivedCallback","onDataReceivedDebounced","_onDataReceived","on","onDataReceiving","bind","data","push","join","callback","write","SET_WATCH_OPTS_DEFAULT","repeat","debounce","edge","setWatchOpts","onKnockCallback","setWatch","onShakeEvent","func","wait","immediate","timeoutId","context","args","arguments","later","apply","callNow","clearTimeout","CODE_DETECT_TIMEOUT_DEFAULT","codeDetectionTimeout","signalTimestamps","signalDetectionInProgress","updateCodeDetectionDebounced","detectCodeDebounced","onCodeDetected","onSignalDetectCallback","timeout"],"mappings":"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","file":"main.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"main\"] = factory();\n\telse\n\t\troot[\"main\"] = factory();\n})(this, function() {\nreturn \n\n\n/** WEBPACK FOOTER **\n ** webpack/universalModuleDefinition\n **/"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n/** WEBPACK FOOTER **\n ** webpack/bootstrap 552385c86ff347ed4ead\n **/","import { App } from \"./App\";\n\nApp.run();\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/main.js\n **/","import { Auth } from \"./services/Auth\";\nimport { logger } from \"./logger\";\nimport { settings } from \"./settings\";\nimport { Bluetooth, Relay, KnockDevice } from \"./Devices\";\nimport { SignalDetectionService } from \"./services/SignalDetection\";\n\nlogger.log('main.js');\n\nconst DEBUG_DEFAULT_CODE = [\n  0.11071835714,0.08259338095,0.10016359523,0.30911060714,0.09569125595,0.51507855357,0.07772857142\n];\n\nlet App = {\n\n  run: () => {\n\n    let isReadyToSetUpNewCode = false;\n\n    let auth = new Auth();\n    let bluetooth = new Bluetooth({serialPort: settings.pin.bluetoothSerial});\n    let relay = new Relay({pin: settings.pin.relayPin});\n    let knockDevice = new KnockDevice({pin: settings.pin.knockPin});\n\n    let signalDetectionService = new SignalDetectionService();\n\n    bluetooth.onDataReceived( () => {\n      logger.log('ready to set up new code');\n      isReadyToSetUpNewCode = true;\n    });\n\n    knockDevice.onKnock((e) => {\n      // todo: generate timestamp based on `e` arg\n      // there is a mistake (e.time - e.lastTime) -> fix it\n      let timestamp = e.time - e.lastTime;\n      signalDetectionService.putTimestamp(timestamp);\n    });\n\n    // TODO: set the code manually\n    auth.setCode(DEBUG_DEFAULT_CODE);\n\n    signalDetectionService.onSignalDetect( (code) => {\n\n      logger.log('code-detected', code);\n\n      if (isReadyToSetUpNewCode) {\n        auth.setCode(code);\n        logger.log('new code has been set');\n        isReadyToSetUpNewCode = false;\n      } else {\n        let authenticated = auth.verifyCode(code);\n        logger.log('authenticated', authenticated);\n\n        if (authenticated) {\n          relay.set(0);\n          setTimeout((()=>{\n            relay.set(1)\n          }), 400)\n        }\n\n      }\n    });\n\n  }\n\n};\n\nexport { App };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/App.js\n **/","import {logger} from \"./../logger\";\n\nlogger.log('Auth.js');\n\nconst Auth = class {\n\n  constructor() {\n    this.code = []; // storing key code, an array of timestamps\n    this.fluctuation = 150; // TODO: must be in percents\n  }\n\n  setCode(code){\n    if (!code) return;\n    if (!(code instanceof Array)) return;\n    this.code = code;\n  }\n  getCode(){\n    return this.code;\n  }\n\n  verifyCode(code){\n    if (!code) return false;\n    if (!(code instanceof Array)) return false;\n    if (code.length !== this.code.length) return false;\n\n    const [signalEnd] = code.slice(-1);\n    const [codeEnd] = this.code.slice(-1);\n\n    let coeff = signalEnd/codeEnd;\n    let result = true;\n    let fluctuation = this.fluctuation;\n    this.code.forEach( (codeItem, index) => {\n      let stamp = code[index]/coeff;\n      let withinRange = ((stamp + fluctuation) >= codeItem && (stamp - fluctuation) <= codeItem);\n      if (!withinRange)\n        result = false;\n    } );\n\n    return result;\n  }\n\n};\n\nexport { Auth };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/services/Auth.js\n **/","import { settings } from './settings';\n\n/**\n * Simplest silly logger for debugging\n *\n * Actually there is a bug with it.\n * For some reason the app is unstable when\n * something is pushed into console.log,\n * as I found - Espruino waits for recipients for logged data\n * and breaks logic if there are no ones\n *\n * @type {Logger}\n */\nconst Logger = class {\n\n  constructor (bluetoothSerial) {\n    this.isEnabled = false;\n    this.bluetoothSerial = bluetoothSerial;\n  }\n\n  log (message, arg) {\n    if (!this.isEnabled) return false;\n    let txt = `${message}: ${arg}`;\n    if (console && console.log)\n      console.log(txt);\n    if (this.bluetoothSerial)\n      this.bluetoothSerial.print(txt);\n  }\n\n  enabled (bool) {\n    this.isEnabled = bool;\n  }\n\n};\n\nlet logger = new Logger(settings.pin.bluetoothSerial);\n\n// TODO: enable when debugging\n//logger.enabled(true);\n\nexport { logger };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/logger.js\n **/","\n// mocking for testing\n// TODO: do not include in prod\n// let BTN1 = BTN1 || null;\n// let P3 = P3 || null;\n// let Serial3 = Serial3 || null;\n\nconst settings = {\n  pin: {\n    knockPin: P2,\n    relayPin: P3,\n    bluetoothSerial: Serial3\n  }\n};\n\nexport { settings };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/settings.js\n **/","import { logger } from \"./logger\";\nimport {debounce} from \"./Utils\";\n\nlogger.log('Devices.js');\n\n/**\n * Bluetooth module\n * example:\n *\n  ```\n    import { Bluetooth } from \"./Devices\";\n    let options = {\n      serialPort: <Object> // e.g. Serial3\n      baudRate: <Number> // e.g. 9600 <- this is default\n      debounceTimeout: <Number> // e.g. 100 <- this is default\n    };\n    let bluetooth = new Bluetooth(options);\n  ```\n *\n */\nconst DEFAULT_BAUD_RATE = 9600;\nconst DEFAULT_DEBOUNCE_TIMEOUT = 100;\n\nconst Bluetooth = class {\n\n  constructor(options){\n    let serial = options.serialPort;\n    let rate = options.baudRate || DEFAULT_BAUD_RATE;\n    let debouceTimeout = options.debounceTimeout || DEFAULT_DEBOUNCE_TIMEOUT;\n    serial.setup(rate);\n\n    this.receivedDataArray = [];\n    this.onDataReceivedCallback = (() => {});\n\n    this.onDataReceivedDebounced =\n      debounce( () => { this._onDataReceived() }, debouceTimeout );\n\n    serial.on('data', this.onDataReceiving.bind(this));\n\n  }\n\n  onDataReceiving(data){\n    this.receivedDataArray.push(data);\n    this.onDataReceivedDebounced();\n  }\n\n  _onDataReceived(){\n    let data = this.receivedDataArray.join(\"\");\n    this.onDataReceivedCallback(data);\n    this.receivedDataArray = [];\n  }\n\n  onDataReceived(callback){\n    this.onDataReceivedCallback = callback || (()=>{});\n  }\n\n};\n\n/**\n * Relay utility module\n * example:\n *\n\n ```\n  import { Relay } from \"./Devices\";\n  let options = {\n    pin: <Object>, // e,g, P1\n  };\n  let relay = new Relay(options);\n\n  relay.set(1);\n  relay.set(true);\n  relay.set(0);\n  relay.set(false);\n\n ```\n *\n */\n\nconst Relay = class {\n\n  constructor(options){\n    this.pin = options.pin;\n  }\n\n  set(bool){\n    this.pin.write(bool ? 1 : 0);\n  }\n\n};\n\n/**\n * KnockDevice module\n * example:\n *\n ```\n import { KnockDevice } from \"./Devices\";\n let options = {\n      pin: <Object>, // e,g, P1\n      setWatchOpts: <Object> // opts passed to setWatch fn\n    };\n let knockDevice = new KnockDevice(options);\n knockDevice.onKnock((e)=>{\n  // callback when knock\n });\n ```\n *\n */\n\nconst SET_WATCH_OPTS_DEFAULT = {\n  repeat: true,\n  debounce: 25,\n  edge: 'rising'\n};\n\nconst KnockDevice = class {\n\n  constructor(options) {\n    logger.log(\"setup KnockDevice\");\n    let pin = options.pin;\n    let setWatchOpts = options.setWatchOpts || SET_WATCH_OPTS_DEFAULT;\n    this.onKnockCallback = (()=>{});\n    setWatch(this.onShakeEvent.bind(this), pin, setWatchOpts);\n  }\n\n  onShakeEvent(e) {\n    logger.log(\"KnockDevice onShakeEvent\");\n    this.onKnockCallback(e);\n  }\n\n  onKnock(callback) {\n    this.onKnockCallback = callback || (() => {});\n  }\n\n};\n\nexport { Bluetooth, Relay, KnockDevice };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/Devices.js\n **/","const debounce = (func, wait, immediate) => {\n  let timeoutId = null;\n  return function() {\n    let context = this, args = arguments;\n    let later = function() {\n      timeoutId = null;\n      if (!immediate) func.apply(context, args);\n    };\n    let callNow = immediate && !timeoutId;\n    if (timeoutId) clearTimeout(timeoutId);\n    timeoutId = setTimeout(later, wait);\n    if (callNow) func.apply(context, args);\n  };\n};\n\nexport { debounce };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/Utils.js\n **/","import { logger } from \"../logger\";\nimport { debounce } from \"../Utils\";\n\nlogger.log('signal-detection.js', 'loaded');\n\n/**\n *\n * Service that helps to putTimestamp timestamped code\n *\n */\n\nconst CODE_DETECT_TIMEOUT_DEFAULT = 2000;\n\nconst SignalDetectionService = class {\n\n  constructor() {\n\n    this.codeDetectionTimeout = CODE_DETECT_TIMEOUT_DEFAULT;\n    this.signalTimestamps = [];\n    this.signalDetectionInProgress = false;\n\n    this.updateCodeDetectionDebounced();\n\n  }\n\n  updateCodeDetectionDebounced (\n    codeDetectionTimeout =\n      this.codeDetectionTimeout || CODE_DETECT_TIMEOUT_DEFAULT\n  ) {\n    logger.log('SignalDetectionService.updateCodeDetectionDebounced()', codeDetectionTimeout);\n    this.detectCodeDebounced = debounce(\n      this.onCodeDetected.bind(this),\n      codeDetectionTimeout\n    );\n  }\n\n  /**\n   * todo: define input, modify the `e` variable taken from espruino's `setWatch` fn\n   * @param timestamp\n   */\n  putTimestamp (timestamp) {\n    logger.log('SignalDetectionService.putTimestamp()', timestamp);\n    if (this.signalDetectionInProgress) {\n      this.signalTimestamps.push(timestamp);\n    }\n    this.signalDetectionInProgress = true;\n    this.detectCodeDebounced();\n  }\n\n  onCodeDetected () {\n    logger.log(\"SignalDetectionService.onCodeDetected\", 'called');\n\n    let callback = this.onSignalDetectCallback || (() => {});\n    callback(this.signalTimestamps);\n\n    this.signalTimestamps = [];\n    this.signalDetectionInProgress = false;\n  }\n\n  onSignalDetect(callback){\n    this.onSignalDetectCallback = callback; // todo check context\n  }\n\n  setDetectionTimeout (timeout) {\n    this.codeDetectionTimeout = timeout;\n    this.updateCodeDetectionDebounced();\n  }\n\n  getTimestamps(){\n    return this.signalTimestamps;\n  }\n\n};\n\nexport { SignalDetectionService };\n\n\n\n/** WEBPACK FOOTER **\n ** ./src/services/SignalDetection.js\n **/"],"sourceRoot":""}